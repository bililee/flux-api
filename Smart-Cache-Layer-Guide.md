# æ™ºèƒ½ç¼“å­˜å±‚æ¶æ„ä½¿ç”¨æŒ‡å—

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäºSpring WebFluxçš„æ™ºèƒ½ç¼“å­˜å±‚ï¼Œä¸»è¦ç”¨ä½œè·¨æœºæˆ¿çš„æµé‡ç¼“å­˜ä»£ç†ã€‚æ”¯æŒå¤šç§ç¼“å­˜ç­–ç•¥ã€è¯·æ±‚å»é‡ã€é™çº§ä¿æŠ¤å’Œå®æ—¶ç›‘æ§ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å¤šçº§ç¼“å­˜ç­–ç•¥**: ä¸»åŠ¨ç¼“å­˜/è¢«åŠ¨ç¼“å­˜/ç›´æ¥é€ä¼ 
- âœ… **è¯·æ±‚å»é‡**: ç›¸åŒè¯·æ±‚åˆå¹¶å¤„ç†ï¼Œé¿å…é‡å¤è°ƒç”¨
- âœ… **åŠ¨æ€é…ç½®**: æ”¯æŒNacosç­‰é…ç½®ä¸­å¿ƒï¼Œçƒ­åŠ è½½æ— éœ€é‡å¯
- âœ… **é™çº§ä¿æŠ¤**: è¿œç¨‹æœåŠ¡å¼‚å¸¸æ—¶è¿”å›è¿‡æœŸç¼“å­˜æˆ–é»˜è®¤å“åº”
- âœ… **ä¸šåŠ¡éš”ç¦»**: åŸºäºSource-Idçš„ä¸šåŠ¡ç»´åº¦ç¼“å­˜ç­–ç•¥
- âœ… **å†…å­˜ä¼˜åŒ–**: é’ˆå¯¹6C8GæœåŠ¡å™¨ä¼˜åŒ–ï¼Œé¿å…GCå½±å“
- âœ… **ç›‘æ§å‘Šè­¦**: ä¸°å¯Œçš„ç›‘æ§æŒ‡æ ‡å’Œå¯æ‰©å±•çš„ç›‘æ§ç³»ç»Ÿ
- âœ… **å¼‚æ­¥å¤„ç†**: å…¨å¼‚æ­¥æ¶æ„ï¼Œè¿œç¨‹æœåŠ¡ä¸é˜»å¡æœ¬åœ°æœåŠ¡

## ğŸ”§ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨ç¼“å­˜é…ç½®å¯åŠ¨
java -jar flux-api.jar --spring.profiles.active=cache

# æˆ–è€…æŒ‡å®šé…ç½®æ–‡ä»¶
java -jar flux-api.jar --spring.config.location=classpath:application-cache.properties
```

### 2. åŸºæœ¬è°ƒç”¨

```bash
curl -X POST http://localhost:8080/v1/specific_data \
  -H "Content-Type: application/json" \
  -H "Source-Id: trading_system" \
  -d '{
    "code_selectors": {
      "include": [
        {
          "type": "stock_code",
          "values": ["48:881169"]
        }
      ]
    },
    "indexes": [
      {
        "index_id": "security_name"
      },
      {
        "index_id": "last_price",
        "time_type": "DAY_1",
        "timestamp": 0,
        "attribute": {}
      }
    ],
    "page_info": {
      "page_begin": 0,
      "page_size": 20
    }
  }'
```

### 3. ç›‘æ§ç«¯ç‚¹

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8080/monitor/health

# ç¼“å­˜ç»Ÿè®¡
curl http://localhost:8080/monitor/cache/stats

# ç³»ç»ŸæŒ‡æ ‡
curl http://localhost:8080/monitor/metrics

# ç”Ÿæˆç›‘æ§æŠ¥å‘Š
curl http://localhost:8080/monitor/report
```

## ğŸ“‹ é…ç½®ç®¡ç†

### ç¼“å­˜ç­–ç•¥é…ç½®

æ”¯æŒé€šè¿‡Nacosç­‰é…ç½®ä¸­å¿ƒåŠ¨æ€é…ç½®ç¼“å­˜ç­–ç•¥ï¼š

```json
{
  "pattern": {
    "code": "48:.*",
    "index": "last_price",
    "source_id": "trading_system"
  },
  "strategy": "ACTIVE",
  "cache_ttl": "5m",
  "refresh_interval": "30s",
  "allow_stale_data": true,
  "priority": 10
}
```

### é…ç½®è¯´æ˜

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `pattern.code` | è‚¡ç¥¨ä»£ç æ­£åˆ™åŒ¹é… | `"48:.*"` |
| `pattern.index` | æŒ‡æ ‡IDæ­£åˆ™åŒ¹é… | `"last_price"` |
| `pattern.source_id` | ä¸šåŠ¡æ¥æºæ­£åˆ™åŒ¹é… | `"trading_system"` |
| `strategy` | ç¼“å­˜ç­–ç•¥ | `ACTIVE`/`PASSIVE`/`NO_CACHE` |
| `cache_ttl` | ç¼“å­˜è¿‡æœŸæ—¶é—´ | `"5m"`, `"30s"`, `"1h"` |
| `refresh_interval` | ä¸»åŠ¨åˆ·æ–°é—´éš” | `"30s"` |
| `allow_stale_data` | æ˜¯å¦å…è®¸è¿”å›è¿‡æœŸæ•°æ® | `true`/`false` |
| `priority` | ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ | `10` |

### è¿œç¨‹æœåŠ¡é…ç½®

```json
{
  "base_url": "https://remote-datacenter.example.com/api",
  "endpoint": "/v1/specific_data",
  "timeout": "5s",
  "max_retries": 2,
  "retry_delay": "500ms",
  "circuit_breaker": {
    "failure_threshold": 5,
    "recovery_timeout": "30s"
  }
}
```

## ğŸš€ ç¼“å­˜ç­–ç•¥è¯¦è§£

### 1. ä¸»åŠ¨ç¼“å­˜ (ACTIVE)

**é€‚ç”¨åœºæ™¯**: é«˜é¢‘è®¿é—®çš„å®æ—¶æ•°æ®ï¼Œå¦‚è‚¡ä»·ã€æŒ‡æ•°ç­‰

**å·¥ä½œåŸç†**:
- æ•°æ®å®šæœŸè‡ªåŠ¨åˆ·æ–°ï¼ˆrefresh_intervalï¼‰
- ç”¨æˆ·è¯·æ±‚ä¼˜å…ˆè¿”å›ç¼“å­˜æ•°æ®
- åå°å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼Œä¸é˜»å¡ç”¨æˆ·è¯·æ±‚

**é…ç½®ç¤ºä¾‹**:
```json
{
  "pattern": {
    "code": "48:881169",
    "index": "last_price"
  },
  "strategy": "ACTIVE",
  "cache_ttl": "5m",
  "refresh_interval": "30s"
}
```

### 2. è¢«åŠ¨ç¼“å­˜ (PASSIVE)

**é€‚ç”¨åœºæ™¯**: ä¸­ç­‰é¢‘ç‡è®¿é—®çš„æ•°æ®ï¼Œå¦‚è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯

**å·¥ä½œåŸç†**:
- é¦–æ¬¡è¯·æ±‚æ—¶è·å–å¹¶ç¼“å­˜æ•°æ®
- ç¼“å­˜è¿‡æœŸåä¸‹æ¬¡è¯·æ±‚æ—¶é‡æ–°è·å–
- æ”¯æŒè¿”å›è¿‡æœŸæ•°æ®ä»¥æé«˜å¯ç”¨æ€§

**é…ç½®ç¤ºä¾‹**:
```json
{
  "pattern": {
    "code": "[0-9]{6}",
    "index": "security_name"
  },
  "strategy": "PASSIVE",
  "cache_ttl": "1h",
  "allow_stale_data": true
}
```

### 3. ç›´æ¥é€ä¼  (NO_CACHE)

**é€‚ç”¨åœºæ™¯**: å®æ—¶æ€§è¦æ±‚æé«˜çš„æ•°æ®

**å·¥ä½œåŸç†**:
- ä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›´æ¥è°ƒç”¨è¿œç¨‹æœåŠ¡
- ä»ç„¶æ”¯æŒè¯·æ±‚å»é‡
- è¿œç¨‹æœåŠ¡å¼‚å¸¸æ—¶å¯è¿”å›é»˜è®¤å“åº”

**é…ç½®ç¤ºä¾‹**:
```json
{
  "pattern": {
    "index": "realtime_.*"
  },
  "strategy": "NO_CACHE"
}
```

## ğŸ”„ è¯·æ±‚å»é‡æœºåˆ¶

### å·¥ä½œåŸç†

1. **è¯·æ±‚é”®ç”Ÿæˆ**: åŸºäºè¯·æ±‚å‚æ•°å’ŒSource-Idç”Ÿæˆå”¯ä¸€é”®
2. **é¦–è¯·æ±‚å¤„ç†**: ç¬¬ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œå®é™…é€»è¾‘
3. **åç»­è¯·æ±‚ç­‰å¾…**: ç›¸åŒè¯·æ±‚åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
4. **ç»“æœå¹¿æ’­**: é¦–è¯·æ±‚å®Œæˆåï¼Œç»“æœåŒæ—¶å“åº”ç»™æ‰€æœ‰ç­‰å¾…çš„è¯·æ±‚

### ä¼˜åŠ¿

- **å‡å°‘è¿œç¨‹è°ƒç”¨**: é¿å…çŸ­æ—¶é—´å†…é‡å¤è¯·æ±‚
- **æé«˜å“åº”é€Ÿåº¦**: åç»­è¯·æ±‚ç›´æ¥è·å¾—ç»“æœ
- **é™ä½ç³»ç»Ÿè´Ÿè½½**: å‡å°‘å¯¹è¿œç¨‹æœåŠ¡çš„å‹åŠ›

## ğŸ“Š ç›‘æ§ä¸å‘Šè­¦

### ç›‘æ§æŒ‡æ ‡

#### ç¼“å­˜ç›¸å…³
- `cache.access` - ç¼“å­˜è®¿é—®æ¬¡æ•°ï¼ˆå‘½ä¸­/æœªå‘½ä¸­ï¼‰
- `cache.refresh` - ç¼“å­˜åˆ·æ–°æ¬¡æ•°ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- `cache.primary.size` - ä¸»ç¼“å­˜å¤§å°
- `cache.primary.hit_rate` - ä¸»ç¼“å­˜å‘½ä¸­ç‡

#### è¿œç¨‹è°ƒç”¨ç›¸å…³
- `remote.call` - è¿œç¨‹è°ƒç”¨æ¬¡æ•°ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- `remote.call.duration` - è¿œç¨‹è°ƒç”¨è€—æ—¶
- `api.response.duration` - APIå“åº”è€—æ—¶

#### è¯·æ±‚å»é‡ç›¸å…³
- `request.deduplication` - è¯·æ±‚å»é‡ç»Ÿè®¡
- `request.wait.duration` - è¯·æ±‚ç­‰å¾…æ—¶é—´
- `request.pending.count` - ç­‰å¾…é˜Ÿåˆ—å¤§å°

#### é™çº§ç›¸å…³
- `fallback.triggered` - é™çº§è§¦å‘æ¬¡æ•°
- `business.error` - ä¸šåŠ¡é”™è¯¯ç»Ÿè®¡

### ç›‘æ§ç«¯ç‚¹

| ç«¯ç‚¹ | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|
| `/monitor/health` | å¥åº·æ£€æŸ¥ | æ•´ä½“æœåŠ¡çŠ¶æ€ |
| `/monitor/cache/stats` | ç¼“å­˜ç»Ÿè®¡ | å‘½ä¸­ç‡ã€å¤§å°ç­‰ |
| `/monitor/metrics` | ç›‘æ§æŒ‡æ ‡ | æ‰€æœ‰æŒ‡æ ‡å¿«ç…§ |
| `/monitor/config` | é…ç½®ä¿¡æ¯ | å½“å‰é…ç½®çŠ¶æ€ |
| `/monitor/system` | ç³»ç»Ÿä¿¡æ¯ | CPUã€å†…å­˜ç­‰ |
| `/monitor/report` | ç”ŸæˆæŠ¥å‘Š | è¯¦ç»†ç›‘æ§æŠ¥å‘Š |

## ğŸ›¡ï¸ é™çº§ç­–ç•¥

### é™çº§è§¦å‘æ¡ä»¶

1. è¿œç¨‹æœåŠ¡è°ƒç”¨è¶…æ—¶
2. è¿œç¨‹æœåŠ¡è¿”å›é”™è¯¯
3. ç½‘ç»œè¿æ¥å¼‚å¸¸
4. ç†”æ–­å™¨å¼€å¯

### é™çº§å¤„ç†æµç¨‹

```mermaid
graph TD
    A[è¿œç¨‹è°ƒç”¨å¤±è´¥] â†’ B{æ£€æŸ¥è¿‡æœŸç¼“å­˜}
    B â†’|æœ‰è¿‡æœŸæ•°æ®| C[è¿”å›è¿‡æœŸç¼“å­˜]
    B â†’|æ— è¿‡æœŸæ•°æ®| D[è¿”å›é»˜è®¤é”™è¯¯å“åº”]
    C â†’ E[è§¦å‘å¼‚æ­¥ä¿®å¤]
    D â†’ E
    E â†’ F[è®°å½•é™çº§æŒ‡æ ‡]
```

### é…ç½®é™çº§ç­–ç•¥

```yaml
cache:
  fallback:
    enable_stale_cache: true
    stale_cache_ttl: 2h
    default_error_message: "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"
    enable_async_repair: true
```

## ğŸ”§ æ‰©å±•é…ç½®æº

### æ”¯æŒçš„é…ç½®æº

- **Nacos**: ç”Ÿäº§æ¨èï¼Œæ”¯æŒçƒ­æ›´æ–°
- **MySQL**: æ•°æ®åº“é…ç½®ï¼Œé€‚åˆå¤æ‚åœºæ™¯
- **Apollo**: æºç¨‹é…ç½®ä¸­å¿ƒ
- **Local File**: æœ¬åœ°æ–‡ä»¶ï¼Œå¼€å‘æµ‹è¯•ç”¨

### æ‰©å±•æ–°é…ç½®æº

1. å®ç° `ConfigSource` æ¥å£
2. æ·»åŠ  `@ConditionalOnProperty` æ¡ä»¶
3. å®ç°é…ç½®ç›‘å¬å’Œçƒ­æ›´æ–°

```java
@Component
@ConditionalOnProperty(name = "config.source.type", havingValue = "mysql")
public class MySqlConfigSource implements ConfigSource {
    // å®ç°é…ç½®æºé€»è¾‘
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ä¼˜åŒ–

- **ä¸»ç¼“å­˜**: æœ€å¤§8000æ¡è®°å½•ï¼Œçº¦500MB
- **è¿‡æœŸç¼“å­˜**: æœ€å¤§2000æ¡è®°å½•ï¼Œçº¦125MB
- **è‡ªåŠ¨æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- **GCå‹å¥½**: é¿å…å¤§å¯¹è±¡åˆ†é…

### å¹¶å‘ä¼˜åŒ–

- **å¼‚æ­¥å¤„ç†**: å…¨æµç¨‹å¼‚æ­¥ï¼Œä¸é˜»å¡è¯·æ±‚
- **çº¿ç¨‹æ± **: ç‹¬ç«‹çš„åˆ·æ–°çº¿ç¨‹æ± 
- **æ— é”è®¾è®¡**: ä½¿ç”¨ConcurrentHashMapç­‰å¹¶å‘å®‰å…¨å®¹å™¨

### ç½‘ç»œä¼˜åŒ–

- **è¿æ¥å¤ç”¨**: WebClientè¿æ¥æ± 
- **è¶…æ—¶æ§åˆ¶**: åˆ†å±‚è¶…æ—¶ä¿æŠ¤
- **é‡è¯•æœºåˆ¶**: æŒ‡æ•°é€€é¿é‡è¯•

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### å•å…ƒæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
mvn test

# è¿è¡Œç‰¹å®šæµ‹è¯•
mvn test -Dtest=SpecificDataServiceImplTest
```

### å‹åŠ›æµ‹è¯•

```bash
# ä½¿ç”¨Apache Bench
ab -n 1000 -c 10 -T application/json \
   -H "Source-Id: test_system" \
   -p test_data.json \
   http://localhost:8080/v1/specific_data

# ä½¿ç”¨JMeter
jmeter -n -t cache_test.jmx -l results.jtl
```

### ç¼“å­˜ç­–ç•¥æµ‹è¯•

```bash
# æµ‹è¯•ä¸»åŠ¨ç¼“å­˜
curl -H "Source-Id: trading_system" \
     -d @active_cache_request.json \
     http://localhost:8080/v1/specific_data

# æµ‹è¯•è¢«åŠ¨ç¼“å­˜
curl -H "Source-Id: info_system" \
     -d @passive_cache_request.json \
     http://localhost:8080/v1/specific_data

# æµ‹è¯•ç›´æ¥é€ä¼ 
curl -H "Source-Id: realtime_system" \
     -d @no_cache_request.json \
     http://localhost:8080/v1/specific_data
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **ç¼“å­˜å‘½ä¸­ç‡ä½**
   - æ£€æŸ¥ç¼“å­˜ç­–ç•¥é…ç½®
   - æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡
   - è°ƒæ•´ç¼“å­˜TTL

2. **è¿œç¨‹è°ƒç”¨å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - æŸ¥çœ‹è¿œç¨‹æœåŠ¡çŠ¶æ€
   - è°ƒæ•´è¶…æ—¶å’Œé‡è¯•é…ç½®

3. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   - æ£€æŸ¥ç¼“å­˜å¤§å°è®¾ç½®
   - æŸ¥çœ‹GCæ—¥å¿—
   - è°ƒæ•´ç¼“å­˜å®¹é‡

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹ç¼“å­˜ç›¸å…³æ—¥å¿—
grep "cache" application.log

# æŸ¥çœ‹è¿œç¨‹è°ƒç”¨æ—¥å¿—
grep "remote" application.log

# æŸ¥çœ‹é™çº§æ—¥å¿—
grep "fallback" application.log
```

## ğŸ“ æœ€ä½³å®è·µ

1. **é…ç½®ç®¡ç†**
   - ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®
   - åˆ†ç¯å¢ƒé…ç½®ç­–ç•¥
   - ç›‘æ§é…ç½®å˜æ›´

2. **ç›‘æ§å‘Šè­¦**
   - è®¾ç½®å…³é”®æŒ‡æ ‡é˜ˆå€¼
   - é…ç½®å‘Šè­¦é€šçŸ¥
   - å®šæœŸæ£€æŸ¥ç›‘æ§æŠ¥å‘Š

3. **å®¹é‡è§„åˆ’**
   - æ ¹æ®ä¸šåŠ¡é‡è°ƒæ•´ç¼“å­˜å¤§å°
   - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
   - é¢„ç•™èµ„æºä½™é‡

4. **ç‰ˆæœ¬å‡çº§**
   - ç°åº¦å‘å¸ƒæ–°ç‰ˆæœ¬
   - ç›‘æ§å…³é”®æŒ‡æ ‡
   - å‡†å¤‡å›æ»šæ–¹æ¡ˆ

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [SpecificData APIæµ‹è¯•æŒ‡å—](./SpecificData-API-Test-Guide.md)
- [å…¨å±€å¼‚å¸¸å¤„ç†æŒ‡å—](./Exception-Handling-Guide.md)
- [Spring WebFluxå®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html)
- [Caffeineç¼“å­˜å®˜æ–¹æ–‡æ¡£](https://github.com/ben-manes/caffeine)